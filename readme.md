#### Автор статьи quakin, оригинальная статья: https://habr.com/ru/articles/785186/
## Статья была перенесена исключительно в целях обучения, для тех кому эти знания пригодятся в работе, в рамках законодательства РФ. 

<h1 class="tm-title tm-title_h1" lang="ru" data-test-id="articleTitle"><span>Личный прокси для чайников: универсальный обход цензуры с помощью VPS, 3X-UI, Reality/CDN и Warp</span></h1><div class="tm-article-body" data-gallery-root lang="ru"><div><!--[--><!--]--></div><div id="post-content-body"><div><div class="article-formatted-body article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/7f8/cef/6f7/7f8cef6f7cfd3a1a7165890b014d7685.png" alt="Карта сокровищ" title="Карта сокровищ" width="780" height="576" data-src="https://habrastorage.org/getpro/habr/upload_files/7f8/cef/6f7/7f8cef6f7cfd3a1a7165890b014d7685.png"/><div><figcaption>Карта сокровищ</figcaption></div></figure><p>На фоне прошлогоднего обострения цензуры в РФ, статьи автора <a href="https://habr.com/ru/users/Deleted-user/publications/articles/" rel="noopener noreferrer nofollow">MiraclePTR </a>стали глотком свободы для многих русскоязычных айтишников. Я же хочу приоткрыть дверь к свободной информации чуть шире и пригласить «не‑технарей» («чайников»), желающих поднять личный прокси‑сервер для обхода цензуры, но дезориентированных обилием информации или остановленных непонятной технической ошибкой.</p><p>В этой статье я описал <em>универсальное</em> решение, которое обеспечивает прозрачный доступ к международному интернету в обход цензуры, использует передовые технологии маскировки трафика, не зависит от одной корпорации и главное — имеет избыточный «<strong>запас прочности</strong>» от воздействия цензоров. </p><p>Статья рассчитана на «чайников», не знакомых с предметной областью. Однако и люди «в теме» могут найти нечто полезное (например, чуть более простую настройку проксирования через CloudFlare без необходимости поднимать nginx на VPS).</p><p>Если у вас ещё нет личного прокси для обхода цензуры — это знак.</p><details class="spoiler"><summary>TL;DR; Универсальное решение:</summary><div class="spoiler__content"><p>VPS в Европе, панель 3X-UI для управление Xray, прокси VLESS-Reality для прямого соединения, прокси VLESS-tls-grpc для запасного соединения через CDN CloudFlare, российский трафик напрямую - либо через цепочку VPS-&gt;WARP, доступ к заблокированным в Европе сервисам - через цепочку VPS-&gt;WARP</p></div></details><h2>Предисловие</h2><p>Пару месяцев назад, в телеграмм‑чате «амнезии» с обсуждением обхода цензуры, нонейм привёл пример «стоматолога из Чертаново», которому интересно‑бы поднять свой сервер, но он «<em>ниасилил</em>» технарские статьи, не готов гуглить ошибки и ему бы понятный мануал: сделай так и всё заработает.</p><p>Я и сам своего рода «стоматолог из Чертаново»: уже более 15 лет не работаю в IT. </p><p>Помню, как пару лет назад купил виртуальный сервер «на поиграться» и боялся вводить там команды, так что весь оплаченный период он бездействовал. Но, в итоге, обход цензуры стал моим хобби, я разобрался в теме и теперь пишу статью, ориентируясь на себя: в прошлом я был бы рад встретить подобную инструкцию.</p><p>Я считаю предлагаемое решение — <u>универсальным</u>. Это моё субъективное мнение, подкреплённое собственным опытом, а также опытом единомышленников (не всех:) из <a href="https://t.me/protocol_vpn" rel="noopener noreferrer nofollow">тг‑чата</a> , где мы обсуждаем настройку и эксплуатацию разных прокси и ви‑пи‑энов. <em>(обращаю внимание что это именно чат, не канал, я не являюсь его владельцем/модератором и он не монетизируется в данный момент. Просто место где можно задать вопрос и поделиться опытом по теме.)</em></p><p><strong>Наверняка найдутся читатели, которые посчитают решение из этой статьи избыточным — либо наоборот, недостаточным</strong> (если так — приглашаю вас в комментарии). Однако я смею утверждать, что — настроив прокси по этой инструкции — вы надолго забудете о проблеме цензуры. </p><p>Выполнение данной инструкции занимает у меня занимает полчаса, у тех кто вообще не в теме — пару вечеров.</p><p>Предлагаю технарям сразу простить меня за то, что описываю некоторые вопросы чересчур подробно: она из целей этой статьи — повышение IT‑образования среди неайтишников.</p><p><strong>Саму инструкцию вы найдёте во второй части статьи</strong>. Сперва же я сориентирую желающих разобраться в текущем положении дел и аргументирую используемые решения.</p><h2>Теория (1/3) Цензура в интернете</h2><h4>Цензура в РФ</h4><p>В РФ сейчас имеют место судебные и внесудебные блокировки. Явно заблокированные ресурсы можно поискать на сайте <a href="https://blocklist.rkn.gov.ru/" rel="noopener noreferrer nofollow">РосКомНадзора (РКН)</a>. К таким ресурсам относятся, например, известные: нельзяграм, мордокнига, рутрекер.</p><p>С внесудебными блокировками всё интереснее. «По периметру» РФ уже стоят «чёрные ящики» — оборудование от РКН — «ТСПУ», которое цензурирует весь пересекающий (по проводам) границу трафик. ТСПУ переводится как Технологические Средства Предотвращения Угроз: <strong>всё, что РКН посчитает «угрозой», может быть втихую заблокировано</strong>. Так, например, сейчас внесудебно <a href="https://habr.com/ru/news/780592/" rel="noopener noreferrer nofollow">блокируют </a>сервис «HideMy.name», летом 2023 <a href="https://habr.com/ru/news/756664/" rel="noopener noreferrer nofollow">блокировали</a> популярные протоколы OpenVPN и WireGuard, а осенью — в южных регионах — <a href="https://habr.com/ru/news/770840/" rel="noopener noreferrer nofollow">блокировали </a>вообще весь непонятный tcp‑трафик.То есть блокировкам подвержены не только ресурсы, но и <em>протоколы</em> передачи данных. </p><p>Многие из внесудебных блокировок возобновляются и прекращаются случайным образом.</p><p>Более того, к <em>внесудебным</em> блокировкам подключатся провайдеры: есть свидетельства внесудебной цензуры трафика внутри страны. Делают ли они это по своей воле или на внутренних интернет‑магистралях также установлены ТСПУ (управляемые РКН) — мне неизвестно.</p><p>Наконец, помимо блокировок, РКН умеет «замедлять» некоторые ресурсы, например — <a href="https://habr.com/ru/news/546280/" rel="noopener noreferrer nofollow">twitter</a>. Возможно в скором времени та же учесть постигнет youtube (считаю, что его однажды не заблокируют, а замедлят... хотя с этим уже успешно <a href="https://habr.com/ru/news/778740/" rel="noopener noreferrer nofollow">справляется сам гугл</a>). Хотел бы ошибаться, но если такое произойдёт, то личный прокси станет хорошим помощником в комфортном доступе к глобальной видео‑библиотеке.</p><p>И последнее: <strong>использование средств обхода цензуры не запрещено</strong> (не является незаконным) в РФ на данный момент.</p><p>Ну и для полноты картины стоит упомянуть силовые методы цензуры: публикация мнений на некоторые темы уголовно наказуема в РФ, и прокси в этом, конечно, не помощник. Прокси помогает получить доступ к уже опубликованной информации.</p><details class="spoiler"><summary>Лирическое отступление</summary><div class="spoiler__content"><p>Я понимаю, что традиционно упоминание цензуры может вызвать возмущение, праведный гнев и осуждение чиновников. Я смотрю на это немного иначе.<br/><br/>На данном этапе истории, цензура «де факто» является неотъемлемой функцией любого государства и ожидать что её не будет уже сегодня — значит бороться с ветряными мельницами. Человечество должно очень сильно измениться, чтобы цензура перестала быть нужна для поддержания целостности государств.<br/><br/>Я же — в текущих реалиях — предпочитаю спокойно реализовывать своё право на свободный доступ к информации (конституция, статья 29) доступными законными методами, и — помимо этого права — создавать то, что считаю ценным. т. е. инвестирую внимание туда, где готов создать на практике, вместо того, чтобы искать, что осудить и уничтожить.<br/><br/>Поэтому, возмущение я рассматриваю как сигнал нереализованности: если мне хочется повозмущаться — значит я недостаточно реализовал свой созидательный потенциал. И лучше пустить энергию на создание чего‑то ценного, чем на возмущение и осуждение. Это моё личное мнение, я его не навязываю, но возможно оно поможет вам сохранить эмоциональный комфорт при упоминании цензуры и при настройке прокси для её обхода.</p></div></details><h4>Цензура за границей</h4><p><strong>На Востоке</strong> — В <a href="https://habr.com/ru/companies/xeovo/articles/753834/" rel="noopener noreferrer nofollow">Китае</a>, Иране и Туркменистане — дела с цензурой обстоят примерно как в РФ — только ещё жёстче. <em>Кстати, именно китайский опыт мы будем использовать для своего прокси</em>.</p><p><strong>А вот на Западе</strong> с цензурой всё интереснее:</p><p>Насколько мне известно, <strong>технический</strong> запрет на доступ к неугодной информации на западе минимален и не сравним с российским. Формально свобода соблюдается</p><p>Блокировка неугодной информации здесь происходит немного иначе. Я вижу три главных тренда:</p><ol><li><p>Манипуляция результатами поисковой выдачи в соцсетях через <a href="https://habr.com/ru/news/702170/" rel="noopener noreferrer nofollow">контроль над СМИ</a> для пропаганды желаемой повестки;</p></li><li><p>Воспитание «<a href="https://ru.wikipedia.org/wiki/%D0%9A%D1%83%D0%BB%D1%8C%D1%82%D1%83%D1%80%D0%B0_%D0%BE%D1%82%D0%BC%D0%B5%D0%BD%D1%8B" rel="noopener noreferrer nofollow">культуры отмены</a>» против инакомыслящих для устранения нежелаемой повестки.</p></li><li><p>Пожалуй, основной тренд: «самоцензура»: самостоятельное ограничение доступа к себе извне. И для этого есть две причины:</p><ol><li><p>выпиливают себя ради соблюдения локальных законов (<a href="https://habr.com/ru/news/784482/" rel="noopener noreferrer nofollow">Порнхаб уходит из Монтаны</a>, <a href="https://habr.com/ru/news/779928/" rel="noopener noreferrer nofollow">Godaddy уходит из РФ</a> и пр ) </p></li><li><p>выпиливают себя из‑за той же «культуры отмены»: ради управления репутационными рисками (из опасения стать изгоями среди своих), либо из‑за личной неприязни к группе людей (из желания <em>отменить</em> кого‑либо самостоятельно)</p></li></ol></li></ol><p>Против первых двух трендов помогает здравый смысл, а против третьего — прокси:).</p><p><strong>Хорошая новость</strong>: практически все технически‑созданные преграды к информации можно обойти с помощью прокси‑сервера.</p><h2>Теория (2/3) - покупка сервера (vps) и домена</h2><p>Для реализации этой инструкции вам понадобится <strong>купить</strong>:</p><ul><li><p>виртуальный сервер за границей (оплачивается помесячно или ежегодно)</p></li><li><p>доменное имя второго уровня (с одной точкой), вроде mypersonalsite.xyz (оплачивается ежегодно)</p></li></ul><p>Хотел бы я дать ссылку на надёжного провайдера VPS (чтобы упростить работу «чайникам», не желающих разбираться в вопросе) — но нет.... универсального хостера я не встречал. Я лишь опишу критерии, а выбирать VPS придётся самому.</p><h4>Критерии выбора VPS</h4><p>Итак, вам нужен VPS, который <strong>удовлетворяет следующим критериям</strong>:</p><ul><li><p>Технические характеристики: 1 процессор, минимум 1 GB оперативной памяти, минимум 5 GB диск. <em>Обычно это самый дешёвый тарифный план</em>.</p></li><li><p>Трафик — безлимитный или очень большой (например 32 Терабайта в месяц). Многим хватает 3 ТБ в месяц, но не всем. Безлимитных вариантов на рынке много.</p></li><li><p>Ширина канала: 100Мбит. Если у вас быстрый домашний/рабочий интернет, то можно смотреть в сторону 1Гбит, такие предложения на рынке есть.</p></li><li><p>Статичный IPv4 адрес (сервер с IPv6 но без IPv4 не подходит)</p></li><li><p>Локация (физическое расположение сервера): Европа. Можно выбрать любую страну, отличную от РФ, но Европа, <em>как правило</em>, даёт самый быстрый трафик.</p></li><li><p>Возможность установки операционной системы "Debian 12". Дальнейшая инструкция гарантированно работает с Debian 12. При выполнении всей цепочки шагов с другой ОС (например, Ubuntu) могут всплыть неожиданные вопросы.</p></li><li><p>Бекап (это платная опция у хостера) не нужен.</p></li></ul><p>Рыночная стоимость такого VPS — $5 / 500 ₽ в месяц. Встречаются дешевле ($0.99/130р.). Дешёвая цена может быть признаком ненадёжности... или не быть.</p><p><strong>А теперь холиварный вопрос</strong>: покупать ли VPS у зарубежного провайдера с помощью зарубежной карты (либо за крипту), или можно купить VPS у хостера, который принимает российские карты?</p><blockquote><p>Однозначного ответа на этот вопрос у меня нет. Если не лень заморочиться — я бы посоветовал зарубежного хостера. Дело в том, что любой платёж российской картой вас деанонимизирует, и товарищ майор при желании узнает, кто оплатил прокси.</p><p>С другой стороны, прокси — это средство обхода цензуры (что вполне законно на данный момент), а не средство анонимности. Ни один прокси не гарантирует <em>абсолютную</em> анонимность в интернете, даже если вы будете платить криптой.</p><p>Для себя я решил этот вопрос так: лично у меня нет задачи «оставаться анонимным» и скрывать факт оплаты сервера за рубежом, поскольку моя деятельность не нарушает российских законов (опять же: на текущий момент). </p><p>Поэтому я оплачиваю зарубежный VPS с помощью российской карты. Меня такое решение устраивает, но я его не навязываю, и — вероятно — поменяю его однажды.</p></blockquote><p>То же самое с доменными именами: можно купить домен.ru за российскую карту, либо любой домен (кроме .ru и .рф) за рубежом.</p><h4>У кого покупать VPS?</h4><ul><li><p><strong>Зарубежные хостеры</strong>: </p><ul><li><p>погуглить "buy vps"</p></li><li><p>посмотреть список рекомендованных хостеров от <a href="https://amnezia.org/ru/instructions/0_starter-guide" rel="noopener noreferrer nofollow">амнезии</a>.</p></li><li><p>Спросить в комментариях или чате (ссылка в начале статьи).<br/><em>Напомню, что у многих зарубежных хостеров есть тенденция ограничивать свои услуги в РФ, поэтому при регистрации не стоит указывать что вы из РФ</em>.</p></li></ul></li><li><p><strong>Российские хостеры</strong>: </p><ul><li><p>Погуглить «купить vps в европе»</p></li><li><p>Поискать на сайте poiskvps. Там большой выбор, но там есть не все.</p></li><li><p>Спросить в комментариях или чате (ссылка в начале статьи)<br/><em>Лично я сейчас арендую VPS у двух провайдеров: nuxt и vdsina. Оба — со своими тараканами, но они пока не так плохи, чтобы переходить на других</em>.</p></li></ul></li></ul><h4>У кого покупать домен?</h4><ul><li><p>.ru можно купить за 119 рублей (дешевле не видел) — гугл в помощь: «<em>зарегистрировать домен.ru</em>».</p></li><li><p>зарубежный можно купить за 99 центов (google: “99 cent domain”)</p></li><li><p>это цена за первый год, продление всегда дороже, но если будет желание сэкономить — можно каждый год покупать новый.</p></li><li><p>бесплатные домены второго уровня были доступны всем ещё летом 2023, но сейчас эта халява закончилась, приходится покупать.</p></li></ul><h2>Теория (3/3) - универсальное решение</h2><blockquote><p>Итак, задача — создать и настроить прокси: быстрый и чтобы не заблокировали.</p></blockquote><p>Уже известно, что:</p><ul><li><p>VPN‑протоколы OpenVPN, WireGuard, IPsec и многие другие легко детектируются и периодически блокируются.</p></li><li><p>Зашифрованные прокси‑протоколы без маскировки (shadowsocks, vmess, mtproto для телеграмма) тоже периодически блокируются. Если работает сегодня, но были прецеденты блокировок — не факт что будет работать завтра. Стоит ли использовать решение, которое может перестать работать в любой момент по воле РКН? Конечно нет.</p></li></ul><p><strong>Поэтому я использую решение, которое:</strong></p><ol><li><p><strong>Маскируется</strong>. Причём под самый популярный протокол в интернете - https (так умеют vless, trojan, cloak, gost-tls, openconnect-tls).</p></li><li><p><strong>Не шифрует зашифрованный трафик повторно</strong>: так называемый tls-in-tls при желании детектируется (<a href="https://github.com/XTLS/Trojan-killer" rel="noopener noreferrer nofollow">пример</a>), хотя и требует инвестиций в более дорогое оборудование ТСПУ. В Китае так уже делают, вероятно скоро научатся и у нас. Я знаю два решения для этого: vless-xtls просто не шифрует трафик дважды, cloak - обходит (вроде бы) этот фильтр за счёт огромной избыточности, но ценой низкой скорости.</p></li><li><p><strong>Притворяется реальным сайтом</strong>: Проходит тест на active-probing. Это когда цензор вместо вас подключается к серверу и убеждается, что вы посещаете какой-то сайт, а не используете его как прокси (так умеют vless-xtls-reality и всё тот же медленный cloak).</p></li></ol><p>Существует классный продукт — <a href="https://amnezia.org/ru" rel="noopener noreferrer nofollow">Amnezia</a>. Она также позиционирует себя как «универсальное решение» и поддерживает подходящий протокол (cloak), но я её не рекомендую из‑за «детских болезней»:</p><ol><li><p>Очень сырой клиент, особенно после обновления на 4 версию: баги и вводящий в заблуждение интерфейс.</p></li><li><p>Единственный протокол с маскировкой (OpenVPN+Cloak) слишком медленный для комфортного использования, </p></li><li><p>Протоколы без маскировки могут скомпрометировать сервер. </p></li></ol><p>Я желаю «Амнезии» успехов — она действительно может стать универсальным решением в будущем, но на сегодня я вижу только одного кандидата: протокол <strong>VLESS‑XTLS‑Reality</strong>.</p><p>На текущий момент vless‑xtls‑reality <u>не может быть обнаружен с помощью DPI</u> (deep packet inspection — прослушивание трафика) даже в Китае. Но у цензора есть иные способы помешать ему. Поэтому смотрим следующий список:</p><h4>Что не стоит делать ни в коем случае</h4><ol><li><p><strong>Не компрометировать VPS</strong> протоколами, которые могут быть обнаружены (не ставить туда WireGuard, OpenVPN, Shadowsocks, ...). Некоторые провайдеры уже <a href="https://habr.com/ru/articles/770400/#comment_26117470" rel="noopener noreferrer nofollow">блокируют</a> VPS, на которых в прошлом были замечены подобные протоколы.</p></li><li><p><strong>Не ходить в рунет через VPS</strong>, вместо этого посещать рунет напрямую, мимо прокси (легко настроить). В крайнем случае, пускать российский трафик по цепочке Я-&gt;VPS-&gt;Warp-&gt;Рунет (это тоже легко настроить). Дело в том, что если трафик  пересекает границу РФ дважды в условную секунду (сначала туда, потом сразу обратно), то цензор может заподозрить прокси и заблокировать его. В Китае так делают, у нас - нет, но могут научиться в любой момент.</p></li><li><p><strong>Не раздавать доступ к прокси</strong> большому количеству людей. 5-10 близких максимум. В Китае уже вычисляют аномальный трафик к серверу от большого числа юзеров (и блокируют сервер), у нас - опять же - могут перенять их опыт в любой момент.</p></li></ol><p>При выполнении этих условий (в текущих реалиях) сервер невозможно вычислить и заблокировать. Однако, я люблю избыточную надёжность, поэтому... на случай неожиданной блокировки VPS‑сервера по IP — есть «<strong>План Б</strong>»: проксирование трафика через CDN (Content Delivery Network).</p><p><strong>CDN CloudFlare</strong></p><p>CDN созданы для балансировки трафика крупных сайтов, состоят из сотен IP‑адресов, поэтому шанс их блокировки в РФ минимальный. Я использую одну из самых крупных CDN в мире — CloudFlare с бесплатным тарифом. Именно к CloudFlare вы привяжете купленный домен, чтобы пускать трафик через него.</p><p>Проксирование через CDN чуть медленнее прямого коннекта к серверу. Зато, при использовании CDN, Роскомнадзор вообще не узнает IP вашего сервера.</p><p><strong>CloudFlare Warp</strong></p><p>Warp - это сеть публичных прокси от той же корпорации CloudFlare, доступ туда происходит по VPN-протоколу WireGuard. Из РФ к Warp-у, конечно же не подключишься, но из зарубежного VPS - запросто.</p><p>В этой схеме Warp исполняет две функции:</p><ol><li><p>Дополнительный инструмент для обхода западной цензуры (если некоторые западные сайты не приветствуют запросы с вашего VPS - вы сможете зайти на них через Warp)</p></li><li><p>Доп. защита от блокировок: проксирование запросов от VPS в Рунет, чтобы не компрометировать VPS в глазах РКН. Это на случай, если вы не настроили клиентское приложение для прямого доступа в ru-ресурсам. Конечно, не все ru-сайты готовы обслуживать запросы из-за границы, например: сайт Почты России почти наверняка не откроется через Warp, но большинство ru-сайтов откроется.</p></li></ol><p><strong>Независимость от корпораций</strong></p><p>Если CloudFlare вдруг исчезнет, вся схема продолжит работать напрямую, при этом останется возможность подключиться к любой другой CDN (из десятки), а вместо Warp использовать любой другой зарубежный прокси. Но пока всё работает - можно использовать CloudFlare.</p><p>На этом теория окончена, перехожу к инструкции.</p><h2>Инструкция (1/6) - настройка VPS</h2><p>Как только вы приобрели VPS‑сервер с уже установленной туда чистой Debian 12 (см «Теорию ч.2» выше) — как правило в течении нескольких минут провайдер выдаст вам доступ к серверу. Чаще всего приходит e‑mail, иногда данные можно найти в панели.</p><figure class="bordered "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/b3a/ab5/66e/b3aab566e6cb6fa52e3029b9c6305491.png" alt="Вам нужны две строки: IP-адрес и root-пароль" title="Вам нужны две строки: IP-адрес и root-пароль" width="459" height="304" data-src="https://habrastorage.org/getpro/habr/upload_files/b3a/ab5/66e/b3aab566e6cb6fa52e3029b9c6305491.png"/><div><figcaption>Вам нужны две строки: IP-адрес и root-пароль</figcaption></div></figure><p><strong>Шаг 1:</strong> Подключитесь к серверу по SSH: </p><ul><li><p>Наберите  <code>ssh root@111.111.111.111</code> в консоли (IP поменяйте на свой).<br/><em>Пароль можно вставить из буфера с помощью ПКМ, он не отображается для безопасности. Иногда пароль вставляется корректно только при включённой английской раскладке клавиатуры.</em> </p></li><li><p>Либо используйте веб-интерфейс "VNC" в панели VPS</p></li><li><p>Либо используйте какое-либо SSH-приложение</p></li></ul><p><strong>Шаг 2:</strong> Обновите систему на сервере  <code>apt update &amp;&amp; apt full-upgrade -y</code> (займёт несколько минут)</p><p><strong>Шаг 3:</strong> Перезагрузитесь <code>reboot</code> и через минуту подключитесь по ssh заново.</p><p><strong>Шаг 4:</strong> Установите необходимые пакеты: <code>apt install docker.io docker-compose git curl bash openssl nano -y</code></p><p><strong>Шаг 5</strong>: Установите панель 3X-UI версии v2.0.2:</p><pre><code class="bash">git clone https://github.com/MHSanaei/3x-ui.git
cd 3x-ui
nano docker-compose.yml
 # откроется текстовой редактор. 
 # в 6 строке замените "latest" на "v2.0.2"
 # было:  image: ghcr.io/mhsanaei/3x-ui:latest
 # стало: image: ghcr.io/mhsanaei/3x-ui:v2.0.2
 # чтобы сохранится, нажмите: CTRL+X, Y, ENTER
docker-compose up -d</code></pre><figure class="float "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/d97/78a/578/d9778a578ce71afd64a8b7be46a8a160.png" alt="nano docker-compose.yml" title="nano docker-compose.yml" width="345" height="316" data-src="https://habrastorage.org/getpro/habr/upload_files/d97/78a/578/d9778a578ce71afd64a8b7be46a8a160.png"/><div><figcaption>nano docker-compose.yml</figcaption></div></figure><p><strong><em>UPD 18.01</em></strong>: Автор панели уже выпустил новую версию, но там поменялся интерфейс и логика работы с WARP, я же создавал инструкцию и делал скриншоты именно с версии v2.0.2, она стабильная и самодостаточная. Если вы ставите прокси первый раз и хотите следовать инструкции - устанавливайте именно эту версию.<br/><br/>В первоначальной инструкции была ошибка - она устанавливала последнюю версию, сейчас всё верно.</p><p><strong>Шаг 6:</strong> Установите Warp: первой командой - удалите (если он был установлен хостером), второй - установите его в режиме совместимости с 3x-ui</p><pre><code class="bash">warp u
bash &lt;(curl -sSL https://raw.githubusercontent.com/hamid-gh98/x-ui-scripts/main/install_warp_proxy.sh)</code></pre><p>Во время установки скрипт спросит у вас цифру, нужно ответить <code>40000</code></p><p><strong>Шаг 7</strong>: Сгенерируйте самоподписанный TLS-сертификат и скопируйте его в панель 3X-UI</p><pre><code>openssl req -x509 -newkey rsa:4096 -nodes -sha256 -keyout private.key -out public.key -days 3650 -subj "/CN=APP"
docker cp private.key 3x-ui:private.key
docker cp public.key 3x-ui:public.key</code></pre><p><strong>На этом настройка сервера завершена.</strong></p><blockquote><p>Можно шаманить дальше, чтобы повышать уровень безопасности сервера и качество его маскировки, но «для старта» я считаю это излишним. Минимально необходимые настройки для стабильной работы сервера вы выполнили.</p></blockquote><h2>Инструкция (2/6) - первичная настройка панели 3X-UI</h2><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/a12/f18/e2d/a12f18e2d17e7bfd76a3a86a26bbe00d.png" alt="Подружитесь со своей тенью" title="Подружитесь со своей тенью" width="611" height="718" data-src="https://habrastorage.org/getpro/habr/upload_files/a12/f18/e2d/a12f18e2d17e7bfd76a3a86a26bbe00d.png"/><div><figcaption>Подружитесь со своей тенью</figcaption></div></figure><p><strong><br/><br/>Шаг 1:</strong> Откройте браузер и зайдите по адресу вида <code>http://111.111.111.111:2053/</code> Обратите внимание на http (не https) в начале адреса (но это только на старте, далее будет https). IP, конечно, нужно поменять на свой.<br/><br/><strong>Шаг 2:</strong> Поменяйте язык на английский (в русском кривой перевод), тёмную тему, логин: <code>admin</code>, пароль: <code>admin</code>, и войти (кнопка Login).</p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/cda/a07/fcf/cdaa07fcf5a890e78be7dff053586308.png" alt="Управляйте своей реальностью" title="Управляйте своей реальностью" width="730" height="521" data-src="https://habrastorage.org/getpro/habr/upload_files/cda/a07/fcf/cdaa07fcf5a890e78be7dff053586308.png"/><div><figcaption>Управляйте своей реальностью</figcaption></div></figure><p><strong>Шаг 3</strong>: В разделе "Panel Settings" заполните 4 поля как на скриншоте:<br/><br/><strong>- Panel Port</strong> (любое случайное число от 1000 до 65535, кроме 40000 - оно уже занято варпом, в инструкции я буду использовать 54321 - но вы придумайте своё). <em>Далее везде вместо порта 54321 вставляйте своё число</em>.<br/><br/> <strong>- Panel Certificate</strong> <strong>Public</strong> Key Path : <code>/public.key</code><br/><br/> <strong>- Panel Certificate</strong> <strong>Private</strong> Key Path : <code>/private.key</code><br/><br/> <strong>- Panel URL</strong> Root Path: секретная строка для доступа к панели, которая начинается и заканчивается "/". Я использую <code>/mysecreturl/</code>, но вы придумайте свою. <em>Далее везде вместо строки </em><code>/mysecreturl/</code><em> используйте свою</em>.</p><p>Наконец, сохранитесь (кнопка Save вверху страницы) и обязательно перезагрузите панель (кнопка Restart Panel, Sure).</p><ul><li><p><strong>Браузер выдаст ошибку</strong>. Поменяйте в адресной строке порт 2053 на 54321, обновите страницу.</p></li><li><p><strong>Браузер выдаст вторую ошибку</strong> «Подключение не защищено» (<em>это потому что мы используем самоподписанный сертификат, но это временно</em>). Нажмите на Дополнительно→Перейти на сайт, и вы опять окажетесь в панели.</p></li></ul><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/0ed/150/13a/0ed15013a5721ce5b6704e3bad0c9d82.png" alt="Будьте собой, остальные роли заняты" title="Будьте собой, остальные роли заняты" width="610" height="419" data-src="https://habrastorage.org/getpro/habr/upload_files/0ed/150/13a/0ed15013a5721ce5b6704e3bad0c9d82.png"/><div><figcaption>Будьте собой, остальные роли заняты</figcaption></div></figure><p><strong>Шаг 4:</strong> В разделе Panel Settings -Security Settings укажите старые(admin/admin) и придумайте новые логин и пароль, жмите Confirm.<br/><br/><strong>Шаг 5:</strong> Войдите в панель ещё раз с новым логином и паролем.<br/>Теперь панель будет всегда доступна по HTTP<u>S</u> адресу вида: <code>https://111.111.111.111:54321/mysecreturl/</code> (где IP, Порт и Путь будут вашими собственными).</p><blockquote><p>Сохраните где-нибудь URL доступа к панели, логин и пароль.</p></blockquote><h2>Инструкция (3/6) - настройка Xray</h2><p>Xray - прокси-сервер, которым управляет панель 3X-UI. Именно Xray поддерживает протокол VLESS с маскировкой.</p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/137/002/90d/13700290d23423cf1523aeec002551f2.png" alt="Всё красиво на бумаге, да забыли про овраги (нет)" title="Всё красиво на бумаге, да забыли про овраги (нет)" width="775" height="739" data-src="https://habrastorage.org/getpro/habr/upload_files/137/002/90d/13700290d23423cf1523aeec002551f2.png"/><div><figcaption>Всё красиво на бумаге, да забыли про овраги (нет)</figcaption></div></figure><p><br/><strong>Шаг 1:</strong> В панели перейдите в раздел "Xray Settings" и включите две опции:<br/><br/><strong>- IPv4 Configs</strong> -&gt; Use IPv4 for Google<br/><br/><strong>- WARP Configs</strong> -&gt; Route OpenAI (ChatGPT) througw WARP.<br/><br/>Затем в верху страницы сохранитесь (Save Settings) и перезагрузитесь (Restart Xray)</p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/8f1/3d6/709/8f13d6709e31f5b0a5e1ddd8e3a5dae2.png" alt="Есть такое слово: &quot;Родина&quot;" title="Есть такое слово: &quot;Родина&quot;" width="533" height="652" data-src="https://habrastorage.org/getpro/habr/upload_files/8f1/3d6/709/8f13d6709e31f5b0a5e1ddd8e3a5dae2.png"/><div><figcaption>Есть такое слово: "Родина"</figcaption></div></figure><p><strong>Шаг 2:</strong> Пустите весь российский трафик на сервере через WARP.<br/><br/>Для этого перейдите в раздел "Xray Settings"-&gt;"Routing Rules", найдите строку где написано "<code>geosite:openai</code>" и отредактируйте её, чтобы получилось: <code>geosite:category-gov-ru,regexp:.*\.ru$,geosite:openai</code><br/><br/>Наконец, добавьте новое правило через кнопку Add Rule (IP: <code>geoip:ru</code>, Outbound tag: <code>WARP</code>) как на скриншоте.<br/><br/>Опять сохранитесь вверху страницы (Save Settings), затем перезагрузитесь (Restart Xray)</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/30d/fdd/bd3/30dfddbd3569bce73487d31321c5224d.png" alt="Правильно заполненная таблица &quot;Routing Rules&quot; - ваш пропуск в интернет, товарищ!" title="Правильно заполненная таблица &quot;Routing Rules&quot; - ваш пропуск в интернет, товарищ!" width="1107" height="411" data-src="https://habrastorage.org/getpro/habr/upload_files/30d/fdd/bd3/30dfddbd3569bce73487d31321c5224d.png"/><div><figcaption>Правильно заполненная таблица "Routing Rules" - ваш пропуск в интернет, товарищ!</figcaption></div></figure><p><strong>Шаг 3:</strong> Найдите сайт‑донор для маскировки.</p><p>Уже на 4-м шаге панель предложит вам маскироваться под сайт <code>yahoo.com</code>. В принципе он подходит. Но если у вас сервер в Европе — это даст задержки при открытии новых сайтов, поскольку сервера yahoo находятся в Америке.</p><p>Оптимальным будет найти сайт в подсети хостера (вот <a href="https://habr.com/ru/articles/770400/#:~:text=%D0%9A%D0%B0%D0%BA%20%D0%B2%D1%8B%D0%B1%D1%80%D0%B0%D1%82%D1%8C%20%D1%81%D0%B0%D0%B9%D1%82%2C%20%D0%BF%D0%BE%D0%B4%20%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D1%8B%D0%B9%20%D1%81%D1%82%D0%BE%D0%B8%D1%82%20%D0%BC%D0%B0%D1%81%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D1%82%D1%8C%D1%81%D1%8F%20%D1%81%20XTLS-Reality%3F" rel="noopener noreferrer nofollow">инструкция</a>), но может случиться так, что в подсети сайта не обнаружится (у меня такое было).</p><p>Поэтому есть более простой вариант: найти небольшой сайт из той‑же страны, где вы арендовали VPS, затем зайти на сервер по SSH и с сервера попинговать его. Если время отклика будет минимальное (например, 15мс) — он подходит.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/3db/d21/a80/3dbd21a80839ee205be9db15ae7bef4e.png" alt="Я арендовал сервер в Нидерландах, поэтому выбрал голландский новостной сайт nltimes.nl - попинговал его с VPS-сервера: вижу время отклика 6мс, он подходит" title="Я арендовал сервер в Нидерландах, поэтому выбрал голландский новостной сайт nltimes.nl - попинговал его с VPS-сервера: вижу время отклика 6мс, он подходит" width="635" height="82" data-src="https://habrastorage.org/getpro/habr/upload_files/3db/d21/a80/3dbd21a80839ee205be9db15ae7bef4e.png"/><div><figcaption>Я арендовал сервер в Нидерландах, поэтому выбрал голландский новостной сайт <code>nltimes.nl</code> - попинговал его с VPS-сервера: вижу время отклика 6мс, он подходит</figcaption></div></figure><blockquote><p><strong>Update 21.02</strong>: Появились сообщения, что сайт nltimes.nl больше не подходит для маскировки - он начал как-то защищаться и маскировка под него довольно скоро перестаёт работать. <em>Для маскировки выбирайте другие сайты</em>.</p></blockquote><figure class="float "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/ef2/bf7/ea4/ef2bf7ea4b0ca8d914362fec3e8e8730.png" alt="Цензура - не волк: VLESS не убежит" title="Цензура - не волк: VLESS не убежит" width="424" height="1280" data-src="https://habrastorage.org/getpro/habr/upload_files/ef2/bf7/ea4/ef2bf7ea4b0ca8d914362fec3e8e8730.png"/><div><figcaption>Цензура - не волк: VLESS не убежит</figcaption></div></figure><p><strong><br/>Шаг 4:</strong> Настройте VLESS<br/><br/>В разделе (Inbound) - (Add inbound) надо заполнить указанные на скриншоте поля.<br/><br/>Самое важное:<br/><br/><strong>- Remark и Email</strong> - любые строки (не обязательно адрес эл.почты), ни на что не влияют.<br/><br/><strong>- Listening IP</strong> - укажите ваш IP<br/><br/><strong>- Port</strong> - строго 443, чтобы маскироваться под обычный https-сайт.<br/><br/><strong>- Только после выбора Security: Reality</strong> появится возможность выбора Flow: xtls-rprx-vision<br/><br/><strong>- uTLS</strong> - именно Chrome, чтобы маскироваться под самый популярный браузер<br/><br/><strong>- Dest, Server Names</strong> - указать сайт-донор (хотя можно оставить <a href="http://yahoo.com" rel="noopener noreferrer nofollow">yahoo.com</a>)<br/><br/><strong>- Кнопка (Get new cert)</strong> генерирует ключи.<br/><br/><strong>- (Create)</strong> завершает создание.</p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/ed9/543/09f/ed954309f7eb39bcc0a25427ad1b5719.png" alt="Ключ сильнее замка" title="Ключ сильнее замка" width="652" height="267" data-src="https://habrastorage.org/getpro/habr/upload_files/ed9/543/09f/ed954309f7eb39bcc0a25427ad1b5719.png"/><div><figcaption>Ключ сильнее замка</figcaption></div></figure><p><strong>Шаг 5:</strong> Получите ключ VLESS<br/><br/>Осталось в разделе Inbounds нажать на (три точки) -&gt; Export Links ... и система даст скопировать строку-ключ вида:</p><blockquote><p><code>vless://e034d537-b028-41f0-9e53-5f0838ea8b3b@111.111.111.111:443?type=tcp&amp;security=reality&amp;pbk=D0Bfsax3Ble2KiqDrOu3_qMJw7qVKyrnWgpvDTVkb3M&amp;fp=chrome&amp;sni=nltimes.nl&amp;sid=64edf3b5&amp;spx=%2F&amp;flow=xtls-rprx-vision#My%20VLESS-Reality</code></p></blockquote><p>Сохраните её в удобном месте.</p><h2>Инструкция (4/6) - настройка клиента (на компьютерах и телефонах)</h2><p>Здесь всего три шага:</p><ol><li><p>Установить приложение</p></li><li><p>Вставить туда строку-ключ с сервера</p></li><li><p>Настроить прямое соединение с Рунетом</p></li></ol><p>Приложений много, они есть практически под все платформы, и они проверены временем.</p><p><strong>Windows:</strong></p><ul><li><p><strong>Hiddify-Next</strong> (<a href="https://github.com/hiddify/hiddify-next/releases/" rel="noopener noreferrer nofollow">Новые версии</a>) (<a href="https://github.com/hiddify/hiddify-next/releases/download/v0.11.1/hiddify-windows-x64-portable.zip" rel="noopener noreferrer nofollow"><strong>Рабочая версия 0.11.1</strong></a>)</p></li><li><p><a href="https://github.com/Matsuridayo/nekoray/releases" rel="noopener noreferrer nofollow">Nekoray</a></p></li><li><p><a href="https://github.com/2dust/v2rayN/releases" rel="noopener noreferrer nofollow">V2rayN</a></p></li></ul><p><strong>Android:</strong></p><ul><li><p><strong>Hiddify-Next</strong> (<a href="https://play.google.com/store/apps/details?id=app.hiddify.com" rel="noopener noreferrer nofollow">Play Market</a>), (<a href="https://github.com/hiddify/hiddify-next/releases/" rel="noopener noreferrer nofollow">GitHub</a>) (<a href="https://github.com/hiddify/hiddify-next/releases/download/v0.11.1/hiddify-android-universal.apk" rel="noopener noreferrer nofollow"><strong>Рабочая версия 0.11.1</strong></a>)</p></li><li><p><a href="https://play.google.com/store/apps/details?id=com.v2ray.ang" rel="noopener noreferrer nofollow">V2rayNG</a></p></li><li><p><a href="https://github.com/MatsuriDayo/NekoBoxForAndroid/releases" rel="noopener noreferrer nofollow">Nekobox</a></p></li></ul><p><strong>iOS:</strong></p><ul><li><p><a href="https://apps.apple.com/us/app/streisand/id6450534064" rel="noopener noreferrer nofollow"><strong>Streisand</strong></a></p></li><li><p><a href="https://apps.apple.com/us/app/shadowrocket/id932747118" rel="noopener noreferrer nofollow">Shadowrocket</a> (платный)</p></li><li><p><a href="https://apps.apple.com/us/app/foxray/id6448898396" rel="noopener noreferrer nofollow">Foxray</a></p></li></ul><p><strong>macOS:</strong></p><ul><li><p><a href="https://github.com/hiddify/hiddify-next/releases/" rel="noopener noreferrer nofollow">Hiddify-Next</a></p></li><li><p><a href="https://apps.apple.com/ru/app/foxray/id6448898396" rel="noopener noreferrer nofollow">FoxRay</a></p></li><li><p><a href="https://apps.apple.com/us/app/streisand/id6450534064" rel="noopener noreferrer nofollow">Streisand</a></p></li></ul><h4>Настройка Hiddify-Next</h4><blockquote><p><strong>UPD 22.03:</strong> С сегодняшнего дня установленные новые версии приложения называются просто Hiddify, без Next. Ссылки не изменились.</p></blockquote><p>Лидером среди приложений является <strong>Hiddify‑Next</strong> от наших иранских коллег.</p><p>Основные его плюсы:</p><ul><li><p>Крайне простой и понятный интерфейс «одна кнопка», минимум настроек.</p></li><li><p>Русский язык</p></li><li><p>Доступен под все платформы кроме iOS (но разработчики скоро сделают и его)</p></li></ul><p>Интерфейс настолько простой, что я решил не делать скриншотов.</p><p>После установки приложения надо сделать всего две вещи:</p><ul><li><p>В настройках установить Регион: RU</p></li><li><p>Скопировать в буфер и вставить в приложение <strong>строку‑ключ vless</strong> через кнопку (+)</p></li></ul><p>Всё! Можно нажимать на огромную круглую кнопку — и прокси заработает!</p><p><strong>Особенности Hiddify-Next на Windows:</strong></p><p>Приложение может работать в двух режимах:</p><ul><li><p>Системный прокси (по умолчанию)</p></li><li><p>TUN-режим </p></li></ul><p>Большинство приложений (в том числе браузеры) понимает первый режим. Но не все. Если какое‑то приложение на Windows не видит ваш прокси — переключитесь в TUN‑режим (в настройках Hiddify‑Next). Чтобы TUN‑режим заработал, Hiddify‑Next необходимо запустить в «режиме администратора» (программа сама вам об этом скажет).</p><p><strong>Особенности Hiddify‑Next на Android:</strong></p><p>На андроиде есть супер‑удобная опция «Раздельное проксирование» (в настройках Hiddify‑Next). На iOS такого нет.</p><p>Раздельное проксирование позволяет выбрать, какие приложения будут использовать прокси. Например, я могу выбрать опцию «<strong>Проксировать только выбранные приложения</strong>» и поставить галочки на: «Нельзяграм, Канву и Хром». После включения прокси, только эти три приложения будут использовать прокси, а остальные (банковские приложения, яндекс‑карты и все остальные) продолжат соединяться со своими серверами напрямую.</p><p>Если настроить раздельное проксирование для выбранных приложений — прокси на телефоне можно держать включённым <strong>постоянно</strong>.</p><h4>Настройка Streisand (iOS)</h4><p><strong>Streisand — бесплатное приложение</strong>, но в декабре оно на несколько дней становилось платным. Если оно опять станет платным в будущем (~200р) — считаю что оно стоит своих денег.</p><p>Итак, всё те же два шага:</p><ol><li><p>Скопировать в буфер и вставить в приложение строку-ключ vless через кнопку (+)</p></li><li><p>Настроить прямое соединение с Рунетом. Тут несколько шагов. <br/><br/>Сначала - скопировать эту длинную строку с настройками в буфер.</p></li></ol><blockquote><p><code>streisand://aW1wb3J0L3JvdXRlOi8vWW5Cc2FYTjBNRERWQVFJREJBVUdEaGdaR2xWeWRXeGxjMTFrYjIxaGFXNU5ZWFJqYUdWeVZHNWhiV1ZlWkc5dFlXbHVVM1J5WVhSbFozbFVkWFZwWktJSEU5VUlDUW9MREEwT0R4QVNXMjkxZEdKdmRXNWtWR0ZuWFdSdmJXRnBiazFoZEdOb1pYSldaRzl0WVdsdVVtbHdWMjVsZEhkdmNtdFdaR2x5WldOMFZtaDVZbkpwWktDaEVWaG5aVzlwY0RweWRWZDBZM0FzZFdSdzFCUVZDZ3dORGhZU1cyOTFkR0p2ZFc1a1ZHRm5YV1J2YldGcGJrMWhkR05vWlhLaEYxbGtiMjFoYVc0NmNuVlpVbFV0WkdseVpXTjBYRWxRU1daT2IyNU5ZWFJqYUY4UUpFUkROVGxETXpsRExVUXdSRVl0TkRsR015MDVRVEl3TFVFMlJUVkVSakkwUkRaRE9RQUlBQk1BR1FBbkFDd0FPd0JBQUVNQVRnQmFBR2dBYndCeUFIb0FnUUNJQUlrQWl3Q1VBSndBcFFDeEFMOEF3UURMQU5VQTRnQUFBQUFBQUFJQkFBQUFBQUFBQUJzQUFBQUFBQUFBQUFBQUFBQUFBQUVK</code></p></blockquote><p>Затем — вставить её в приложение через «+» справа‑вверху.</p><p>Наконец, зайди в «Роутинг», и там (поставить галочку), (нажать на «включить») и вернуться назад (стрелка слева)</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/38a/a75/3df/38aa753df46566f7cce3a0c262c6754b.png" alt="Эффект Streisand: ON" title="Эффект Streisand: ON" width="1280" height="426" data-src="https://habrastorage.org/getpro/habr/upload_files/38a/a75/3df/38aa753df46566f7cce3a0c262c6754b.png"/><div><figcaption>Эффект Streisand: ON</figcaption></div></figure><p>Можно подключаться! (при первом подключении телефон попросит пароль).</p><blockquote><p>Я ограничил инструкцию двумя приложениями, но если вы захотите поэкспериментировать с другими - в конце статьи будут три ссылки где искать доп. информацию.</p></blockquote><p><strong><em>upd:</em></strong><em> у меня нет macOS чтобы проверить, но </em><a href="https://habr.com/ru/users/Spoofi/" rel="noopener noreferrer nofollow"><em>@Spoofi</em></a><em> подсказал, что MacOS Hiddify Next на данный момент «не умеет» tun-режим (о tun я писал выше), но это умеет FoxRay.</em></p><p><strong><em>upd 25.01</em></strong><em>. Streisand начал показывать рекламу. Чтобы она не мешала - после завершения всех настроек - вы сможете включать/выключать VPN через настройки системы, а не через интерфейс приложения. Другой вариант - пользоваться платным ShadowRocket. В конце статьи будут ссылки - там можно найти инструкции по настройке ShadowRocket. Если же вы настраиваете прокси впервые - рекомендую начать именно со Streisand.</em></p><h2>Инструкция (5/6) -- проверка прокси</h2><p>Если вы всё сделали по инструкции — у вас на устройствах уже должен быть работающий прокси. Но выполняет ли он свою функцию? Не обманул ли продавец VPS? Сейчас проверим.</p><ol><li><p>Убедитесь, что прокси включён.</p></li><li><p>В браузере зайдите на <a href="https://ipinfo.io/" rel="noopener noreferrer nofollow">https://ipinfo.io/</a> . Вы видите IP вашего VPS? Значит прокси работает и и вы всё настроили верно.</p></li><li><p>Откройте браузер и зайдите на <a href="https://rutracker.org" rel="noopener noreferrer nofollow">https://rutracker.org</a>. Открывает? значит РФ‑цензуру обошли.</p></li><li><p>Откройте браузер в режиме <u>инкогнито</u> и зайдите на <a href="https://maps.google.com" rel="noopener noreferrer nofollow">https://maps.google.com</a>. Вы видите карту той страны где покупали VPS? Вероятно ip «чистый».</p></li><li><p>Ещё раз посмотрите на <a href="https://ipinfo.io/" rel="noopener noreferrer nofollow">https://ipinfo.io/</a> . Справа в разделе <code>country</code> вы видите ту страну в которой находится VPS? Значит ip «чистый».</p></li><li><p>Зайдите на <a href="https://canva.com" rel="noopener noreferrer nofollow">https://canva.com</a> Вы видите нормальный сайт и вас не посылают за то что вы из РФ? Значит западную цензуру обошли.</p></li><li><p>Зайдите на <a href="https://google.com" rel="noopener noreferrer nofollow">https://google.com</a> Нет ошибки 403 и поиск доступен? Значит гугл не забанил ранее ваш IP.</p></li></ol><p>Если что‑то пошло не так:</p><ul><li><p>п2 и п3: скорее всего где‑то ошиблись в выполнении инструкции, перепроверьте.</p></li><li><p>п4,5,6 — вероятно хостер предоставил вам «грязный» IP, который числится в базах как российский. Есть шанс, что в течение двух недель базы обновятся... либо не обновятся. Имеет смысл <u>написать в техподдержку хостеру</u>, описать ситуацию и попросить поменять IP. Большинство идут на сотрудничество.</p></li><li><p>п7 — просите хостера поменять IP.</p></li></ul><p><strong>Запасной план:</strong></p><p>Если какой‑либо западный сайт не пускает вас к себе через VPS, то <em>в качестве костыля</em> можно пустить трафик до этого сайта через WARP.</p><p>Для этого в панели 3x-ui-&gt;Xray Settings-&gt;Routing Rules нужно найти и отредактировать строку <code>geosite:category-gov-ru,regexp:.*\.ru$,geosite:openai</code> - дописать сайты через запятую, пример <code>geosite:category-gov-ru,regexp:.*\.ru$,geosite:openai,intel.com,canva.com</code> (обязательно сохраните изменения и перезагрузите Xray)</p><p>После этого западные сайты вместо IP вашего VPS будут видеть IP сети WARP, что почти наверняка позволит обойти их цензуру.</p><p><strong>Да, покупка IP‑адреса — это всегда лотерея и есть небольшой шанс проблем, но чаще всего всё работает с первого раза.</strong></p><h2>Инструкция (6/6) -- настройка CDN CloudFlare</h2><p>Переходим к последнему, самому интересному разделу.</p><p>Любое управление рисками сводится к трём шагам:</p><ul><li><p>Определить риск (в данном случае, это риск, что рф-цензура заблокирует ваш сервер)</p></li><li><p>Минимизировать риск (вы это уже сделали, воплотив знания из "Теории ч3")</p></li><li><p>Определить План Б на тот редкий случай, если риск всё-же реализуется.</p></li></ul><blockquote><p><em>Хотя я не верю, что - с принятой предосторожностью - сервер вообще может быть когда-либо заблокирован, но обычно реальность не интересуется нашими верованиями.</em></p></blockquote><p><strong>Проксирование через CDN - это и есть "План Б".</strong> Сейчас вы настроите ещё одно, запасное соединение, которое будет работать, даже если ваш VPS станет недоступен изнутри РФ.</p><p><strong>Шаг 1:</strong> Выберите продавца доменного имени и убедитесь что доменное имя свободно (см. Теория ч2), но НЕ ПОКУПАЙТЕ его пока. CloudFlare работает только с доменными именами второго уровня (есть исключения, но они нам не помогут). Доменное имя второго уровня — это имя с одной точкой, вроде <code>mypersonalsite.com</code> или <code>myhabraproxy.ru</code>.</p><p>Для этой инструкции я выбрал доменное имя <code>habraproxy.store</code> у продавца Dreamhost. <em>Прямо сейчас dreamhost бесплатно раздаёт доменные имена.store на 1 год — но эта халява только для клиентов, которые в прошлом что‑то уже покупали.</em></p><details class="spoiler"><summary>Кстати, если у вас уже есть свой сайт с доменом...</summary><div class="spoiler__content"><p><em>...то вы точно не «чайник», и вы точно разберётесь, как поменять name‑сервера у регистратора, настроить нормальную работу своего сайта через CloudFlare, а для целей проксирования VPS использовать поддомен.</em></p></div></details><p>Итак, продавец выбран, доменное имя выбрано <u>но не куплено</u>, идём дальше.</p><p><strong>Шаг 2: </strong>Зарегистрируйтесь на <a href="http://CloudFlare.com" rel="noopener noreferrer nofollow">CloudFlare.com</a> (Sign Up — Тариф Free — Add Website — e‑mail+пароль). Сохраните пароль, подтвердите аккаунт по ссылке из письма.</p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/e61/bbf/7a8/e61bbf7a8f53d50b895b8c72e2d72c98.png" alt="Кажется дождь начинается" title="Кажется дождь начинается" width="901" height="450" data-src="https://habrastorage.org/getpro/habr/upload_files/e61/bbf/7a8/e61bbf7a8f53d50b895b8c72e2d72c98.png"/><div><figcaption>Кажется дождь начинается</figcaption></div></figure><p><strong>Шаг 3:</strong> Зайдите в CloudFlare, в верхнем разделе "Websites" добавьте ещё не купленное доменное имя. Далее - Тариф Free - Continue... пока наконец вы не попадёте на страницу "Change your nameservers" с <strong>двумя оранжевыми облаками</strong>.<br/> <br/>Эти две строки нам понадобятся. Ваши строки могут отличаться от моих.</p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/7e8/045/4f4/7e80454f4748ee5a837150771474edae.png" alt="Мы пойдём другим путём" title="Мы пойдём другим путём" width="699" height="718" data-src="https://habrastorage.org/getpro/habr/upload_files/7e8/045/4f4/7e80454f4748ee5a837150771474edae.png"/><div><figcaption>Мы пойдём другим путём</figcaption></div></figure><p><strong>Шаг 4</strong>: Теперь смело покупайте ваше доменное имя, а во время покупки укажите, что будете использовать name-сервера свои, а не те что предлагает продавец. Впишите эти две строки и завершите покупку.<br/><br/>На скриншоте - сайт моего продавца.<br/><br/></p><p>Итак, вы купили домен и указали нужные неймсервера. Активация свежекупленного домена займёт несколько минут, самое время донастроить CloudFlare.</p><p><strong>Шаг 6:</strong> В разделе (DNS) создайте A‑запись для вашего домена и IP вашего сервера. У меня это выглядит вот так:</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/812/03b/950/81203b95011ffba69b3a1885eb32e92b.png" alt="Маскировка 80 Level" title="Маскировка 80 Level" width="1717" height="593" data-src="https://habrastorage.org/getpro/habr/upload_files/812/03b/950/81203b95011ffba69b3a1885eb32e92b.png"/><div><figcaption>Маскировка 80 Level</figcaption></div></figure><p><strong>Шаг 7:</strong>  (обойдусь без скриншотов)</p><ul><li><p>В разделе (Network) включите "gRPC"</p></li><li><p>В разделе (SSL/TLS)--(Edge Certificates)--(Minimum TLS Version) установите "TLS 1.3"</p></li></ul><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/99e/0e6/d1b/99e0e6d1b524734cb0c75d470eabacc2.png" alt="Мировое господство, &quot;основанное на правилах&quot;" title="Мировое господство, &quot;основанное на правилах&quot;" width="891" height="871" data-src="https://habrastorage.org/getpro/habr/upload_files/99e/0e6/d1b/99e0e6d1b524734cb0c75d470eabacc2.png"/><div><figcaption>Мировое господство, "основанное на правилах"</figcaption></div></figure><p><strong>Шаг 8:</strong> В разделе (Rules)--(Origin Rules) создайте два правила: <br/><br/><strong>(1)</strong> Все запросы на сервер направляйте на порт 54321 (укажите порт, на котором работает ваша панель 3xui) <br/><br/><strong>(2)</strong> Все запросы по секретному адресу <code>/my-gRPC-3049382</code> (придумайте что-то своё) направляйте на порт 2053<br/><br/>Последовательность этих двух правил важна.</p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/39a/e61/5f6/39ae615f6fbdc8d49b9d048d45613d7f.png" alt="Нажми на кнопку - получишь результат!" title="Нажми на кнопку - получишь результат!" width="792" height="449" data-src="https://habrastorage.org/getpro/habr/upload_files/39a/e61/5f6/39ae615f6fbdc8d49b9d048d45613d7f.png"/><div><figcaption>Нажми на кнопку - получишь результат!</figcaption></div></figure><p><strong>Шаг 9:</strong> Вернитесь на (Overview), и если под оранжевыми облаками найдёте кнопку "Check nameservers now" - нажмите её, чтобы поторопить систему. <br/><br/><em>(если прошло много времени и там нет ни облаков, ни кнопки - вообще отлично, переходите к следующему шагу)</em></p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/a05/482/b2c/a05482b2c6cebe19b335fddb04ac496b.png" alt="Цензура нервно курит в сторонке" title="Цензура нервно курит в сторонке" width="547" height="1329" data-src="https://habrastorage.org/getpro/habr/upload_files/a05/482/b2c/a05482b2c6cebe19b335fddb04ac496b.png"/><div><figcaption>Цензура нервно курит в сторонке</figcaption></div></figure><p><strong>Шаг 9¾:</strong> Создайте второе VLESS-подключение для CDN.<br/><br/>Вернитесь в панель 3X-UI. Inbound -Add Inbound<br/><br/><strong>Самое важное:</strong><br/><br/><strong>- Порт</strong> - тот же, что и во "втором правиле". 2053 или любой другой на ваш выбор (но смысла менять его на другой не вижу).<br/><br/><strong>- Transmission</strong> - gRPC, именно такой тип соединения безлимитен на CloudFlare.<br/><br/><strong>- Service name</strong> - секретная строка из "второго правила" <code>my-gRPC-3049382</code>, но строго без "/" в начале.<br/><br/><strong>- uTLS</strong> - именно Chrome, чтобы маскироваться под самый популярный браузер<br/><br/><strong>- ALPN</strong> сделайте пустым.<br/><br/><strong>- Кнопка (Get Сert from Panel)</strong> вписывает ключи.<br/><br/><strong>- Allow Insecure</strong> - включайте на время тестирования, когда начнёте пользоваться CDN - можно будет выключить.</p><p>Наконец, проверяйте что получилось. Экспортируйте <u>строку-ключ</u> этого нового соединения и скопируйте её в приложение - <strong>прокси должен работать</strong>. (пока это не CDN, вы лишь подключились к своему VPS через порт 2053 по протоколу VLESS-gRPC, но скоро вместо вас это будет делать CloudFlare)</p><blockquote><p><strong>Update</strong>. В новых версиях многих приложений появился либо баг, либо "фича", которая делает их несовместимыми с этим шагом инструкции. Вероятно особенность в новой версии ядра sing-box, которое лежит в основе всех клиентских приложений.<br/><br/><strong>Что делать?</strong> Использовать проверенную версию приложения Hiddify-Next версии 0.11.1<br/><br/><strong><em>Либо так</em></strong>: в большинстве случаев заполнение поля SNI именем домена (например <code>habraproxy.store</code> -- на скриншоте не заполнено) решает вопрос совместимости с новыми версиями.<br/><br/><strong>Что делать если у вас iOS</strong>, где доступны только свежие версии приложений?<br/>a) выполните этот шаг по инструкции. Есть шанс, что прямое соединение не заработает, но оно пригодится на шаге 13<br/>b) выполните шаг 13 по обновлённой инструкции, CDN заработает.</p></blockquote><p><br/><br/><strong>Шаг 10:</strong> Финальная настройка CloudFlare.</p><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/9d9/1d3/968/9d91d396835bd8b8520582729a3aed2b.png" alt="Каково это, быть избранным?" title="Каково это, быть избранным?" width="870" height="326" data-src="https://habrastorage.org/getpro/habr/upload_files/9d9/1d3/968/9d91d396835bd8b8520582729a3aed2b.png"/><div><figcaption>Каково это, быть избранным?</figcaption></div></figure><p>Обновите раздел Overview. <br/><br/>CloudFlare должен вас обрадовать сообщением: "<em>Great news! Cludflare is now protecting your site</em>"<br/></p><p>Если этого сообщения нет, а вместо него  - страница, на которой остались два оранжевых облака - значит одно из двух:</p><ul><li><p>Нужно ещё немного подождать</p></li><li><p>Вы что-то сделали не так. </p></li></ul><figure class="float full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/ba6/e8f/f79/ba6e8ff79f7fc0d03bc809891f83899c.png" alt="Доквантовая криптография, скриншот начала 21 века" title="Доквантовая криптография, скриншот начала 21 века" width="1254" height="386" data-src="https://habrastorage.org/getpro/habr/upload_files/ba6/e8f/f79/ba6e8ff79f7fc0d03bc809891f83899c.png"/><div><figcaption>Доквантовая криптография, скриншот начала 21 века</figcaption></div></figure><p>Если всё так, тогда: в разделе SSL/TLS включите режим Full<br/><br/><strong>Теперь вы точно завершили настройку CloudFlare.</strong></p><p><strong>Шаг 11:</strong> Проверка.</p><p>Откройте браузер и перейдите по адресу <code>https://habraproxy.store/mysecreturl/</code> (меняйте имя сайта на своё, и адрес страницы на свой - тот что установили для панели 3x-ui).</p><p><strong>Откроется панель 3x-ui</strong>. Теперь управлять панелью вы будете с этого адреса!</p><p>Сохраните этот адрес где-нибудь.</p><p><strong>Шаг 12:</strong> Ещё одна проверка.</p><p>Откройте браузер по адресу <code>https://habraproxy.store</code> и убедитесь, что там пустая страница 404.</p><blockquote><p><em>Это значит любой цензор, зайдя на ваш сайт, убедится: там есть настоящий веб-сервер. В качестве веб-сервера выступает сама панель 3x-ui, которая отдаёт 404 ошибку на любой неизвестный ей адрес. Никакой внешний наблюдатель не узнает адрес панели (</em><code>/secreturl/</code><em>). А если цензор послушает трафик, то увидит зашифрованный поток gRPC, который используется для обслуживания веб-приложений по всему интернету.</em></p></blockquote><p><strong>Шаг 13:</strong> Настало время МАГИИ:</p><p>Отредактируйте строку-ключ второго подключения:</p><ul><li><p>Замените IP на доменное имя,</p></li><li><p>Замените порт на :443,</p></li><li><p>Удалите <code>&amp;alpn=&amp;allowInsecure=1</code></p></li><li><p>Добавьте (перед <code>#</code>) <code>&amp;sni=habraproxy.store</code> <em>впишите свой домен, не мой:)</em></p></li><li><p>Отредактируйте имя (после <code>#</code>) по своему желанию</p></li></ul><p><strong>Было:</strong> <code>vless://03684ba0-1994-4106-86da-e91fdd9007e0@111.111.111.111:2053?type=grpc&amp;serviceName=my-gRPC-3049382&amp;security=tls&amp;fp=chrome&amp;alpn=&amp;allowInsecure=1#My%20CDN-tjo1gifl</code></p><p><strong>Стало:</strong> <code>vless://03684ba0-1994-4106-86da-e91fdd9007e0@habraproxy.store:443?type=grpc&amp;serviceName=my-gRPC-3049382&amp;security=tls&amp;fp=chrome&amp;sni=habraproxy.store#My%20CDN</code></p><p>Наконец, <strong>копируйте эту строку в приложение</strong>, <strong>проверяйте работоспособность</strong> и <strong>наслаждайтесь</strong> запасным каналом для своего прокси. </p><p>Самое время процитировать <a class="mention" href="/users/miracleptr">@MiraclePtr</a>:</p><blockquote><p><strong>Fair use<br/></strong><em>Понятное дело, что то, что CDN разрешают на своих бесплатных тарифах проксировать Websockets и gRPC — это такой жест доброй воли от них. Давайте не наглеть и использовать эти возможности только в совсем безвыходных случаях, которые, надеюсь, все‑таки не наступят.</em></p></blockquote><p><code>&lt;/КОНЕЦ ИНСТРУКЦИИ&gt;</code></p><h2>Недостатки этого решения</h2><ol><li><p><strong>«Сложность» настройки:</strong><br/>Безусловно, купить VPN за 100 рублей в месяц намного проще, чем впервые в жизни настроить «вот это всё». Я не строю иллюзий, что «все домохозяйки в стране сделают прокси частью своего хозяйства». Это решение — для небольшого числа людей, которые <em>очень</em> ценят свободу информации, <em>очень</em> ценят надёжность и готовы инвестировать своё внимание во всякое «технарское колдунство».</p></li><li><p><strong>Периодическая недоступность VPS:</strong><br/>Uptime бюджетного VPS — <em>примерно</em> 99.9% (бывает и выше, и ниже). Это значит, что примерно 42 минуты в месяц VPS может быть недоступен (иногда эти минуты растягиваются до часов и даже дней). То есть вы гарантированно однажды встретитесь с ситуацией, когда VPS временно не отвечает ни по IP, ни через CDN. Причин множество, я встречался как минимум с этими тремя: факап хостера, DDOS‑атака на хостера, проблемы в дата‑центре где физически находится VPS (на которые сам хостер повлиять не может).</p><p>Я решаю этот вопрос просто — у меня два сервера от разных хостеров в разных странах (основной и запасной), этого хватает.</p><p>Другое решение — на случай форс‑мажора иметь под рукой запасную строку‑ключ (shadowsocks, vless, trojan) от какого‑нибудь бесплатного сервиса, благо в телеграмме их полно. Конечно, передавать свой трафик через бесплатный сервис — это <a href="https://habr.com/ru/companies/xeovo/articles/746446/" rel="noopener noreferrer nofollow">стрёмно</a>, но если VPS недоступен, а доступ нужен срочно, то временное использование бесплатного сервиса может оказаться приемлемым, решайте сами.</p></li><li><p><strong>Доверие китайским программистам:</strong><br/>Хотя и сервер, и клиенты — это opensource приложения (основанные на <a href="https://github.com/XTLS/" rel="noopener noreferrer nofollow">Xray</a> и <a href="https://github.com/SagerNet/sing-box" rel="noopener noreferrer nofollow">SingBox</a>), они не проходили независимый аудит, и <em>теоретически</em> там могут быть ошибки, а разработчики — тоже <em>теоретически</em> — могут добавить зловредный код в новые версии (впрочем, такое можно сказать про любое opensource‑решение, но это не мешает существованию опенсорса в мире). Один из вариантов управления этим риском — использовать проверенные версии клиентских и серверных приложений. Пользуясь компьютером и телефоном вы уже доверяете сотням людей и корпораций. Если эти opensource‑решения не вызывают у вас доверия — стоит поискать другие. Я же не вижу здесь никакой проблемы, лишь озвучиваю существующее мнение.</p></li><li><p><strong>Отсутствие XTLS в CDN‑проксировании:</strong><br/>Да, моё решение использует XTLS только для соединения с сервером напрямую, и простой TLS для проксирования через CDN. Я не нашёл способа <em>простой</em> настройки XTLS через CDN, но всё же это возможно. В конце статьи будут ссылки с решением. В РФ пока не умеют детектировать шифрование уже зашифрованного трафика (tls‑in‑tls), но если научатся — это может быть потенциальной проблемой, хотя я оцениваю этот шанс как стремящийся к нулю.</p></li><li><p><strong>Обход цензуры, не анонимность:</strong><br/>Да, использование прокси <strong>заметно повышает уровень анонимности</strong> в интернете, но ни один прокси<strong> не гарантирует абсолютной анонимности</strong>. Данное решение не заточено на анонимность, оно для обхода цензуры — свободного доступа к информации. Пожалуйста, не путайте обход цензуры и анонимность, это очень разные задачи.</p></li></ol><hr/><p><strong>Я постарался сделать эту статью исчерпывающей и самодостаточной, чтобы своими руками настроить личный прокси‑сервер для обхода цензуры, с избыточной защитой от блокировок.</strong></p><p>Но на тот случай, если вы захотите разобраться в вопросе глубже — рекомендую эти три статьи, в которых я черпал вдохновение, и которые содержат дополнительные технические детали и нюансы:</p><ul><li><p><a href="https://habr.com/ru/articles/735536/" rel="noopener noreferrer nofollow">3X-UI: Shadowsocks-2022 &amp; XRay (XTLS) сервер с простой настройкой и приятным интерфейсом</a></p></li><li><p><a href="https://habr.com/ru/articles/770400/" rel="noopener noreferrer nofollow">FAQ по Shadowsocks/XRay/XTLS/Reality/Nekobox/etc. для обхода блокировок</a></p></li><li><p><a href="https://habr.com/ru/articles/761798/" rel="noopener noreferrer nofollow">Особенности проксирования через CDN/Websocket/gRPC для обхода блокировок</a></p></li></ul><p></p></div></div></div><!----><!----></div><!----><!----></div><!--]--><!---->
